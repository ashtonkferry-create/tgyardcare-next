---
phase: 02-supabase-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false
user_setup:
  - service: supabase
    why: "Backend database and auth provider"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    account_setup:
      - task: "Create Supabase account"
        url: "https://supabase.com/dashboard"
      - task: "Create new project (select free tier)"
        details: "Name: tgyardcare, Region: closest to business location"
    dashboard_config:
      - task: "Copy API credentials for Lovable integration"
        location: "Project Settings -> API"

must_haves:
  truths:
    - "Supabase project exists and is accessible"
    - "Lovable site can connect to Supabase"
    - "Database has leads table with required fields"
    - "Anonymous users can insert leads (form submissions)"
    - "Only authenticated admins can read leads"
  artifacts:
    - path: "supabase/migrations/001_create_leads_table.sql"
      provides: "Leads table schema"
      contains: "CREATE TABLE leads"
    - path: "supabase/migrations/002_leads_rls_policies.sql"
      provides: "Row Level Security policies"
      contains: "CREATE POLICY"
  key_links:
    - from: "Lovable project"
      to: "Supabase API"
      via: "Environment variables"
      pattern: "SUPABASE_URL.*SUPABASE_ANON_KEY"
    - from: "leads table"
      to: "RLS policies"
      via: "PostgreSQL security"
      pattern: "ENABLE ROW LEVEL SECURITY"
---

<objective>
Set up Supabase project as the backend database and configure the leads table to store contact form submissions.

Purpose: Establish the data layer for the website, replacing manual form handling with persistent database storage.

Output: Working Supabase project connected to Lovable with a secure leads table ready to receive form submissions.
</objective>

<execution_context>
@C:\Users\vance\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\vance\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\PROJECT.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\ROADMAP.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\STATE.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\phases\01-github-lovable-setup\01-01-SUMMARY.md

Key facts from Phase 1:
- Lovable site exists at tgyardcare.com
- Repository at TotalGuardYardCare/tgyardcarecom
- Local code at C:\Users\vance\OneDrive\Desktop\claude-workspace\tgyardcare
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Set up Supabase project and retrieve credentials</name>
  <action>
    You (the user) need to:

    1. Go to https://supabase.com/dashboard
    2. Sign up or log in with totalguardllc@gmail.com
    3. Click "New Project"
       - Organization: Create "TotalGuard" (or use existing)
       - Name: tgyardcare
       - Database Password: Generate strong password and save securely
       - Region: Choose closest to business location
       - Pricing Plan: Free
    4. Wait for project creation (2-3 minutes)
    5. Once ready, go to Project Settings -> API
    6. Copy two values:
       - Project URL (looks like https://xxx.supabase.co)
       - anon public key (starts with "eyJ...")

    After you have these credentials, go to Lovable project settings and add Supabase integration:
    - In Lovable.dev, open tgyardcare project
    - Go to Settings -> Integrations
    - Add Supabase integration
    - Paste Project URL and anon key

    Reply with: "Supabase connected" when complete.
  </action>
  <verify>N/A - human setup</verify>
  <done>User confirms Supabase project exists and credentials are configured in Lovable</done>
</task>

<task type="auto">
  <name>Create leads table with schema</name>
  <files>supabase/migrations/001_create_leads_table.sql</files>
  <action>
    Create SQL migration file to define the leads table schema.

    Table: leads
    Columns:
    - id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
    - created_at: timestamptz DEFAULT now()
    - name: text NOT NULL
    - email: text NOT NULL
    - phone: text
    - service_interest: text
    - property_size: text
    - message: text
    - status: text DEFAULT 'new' CHECK (status IN ('new', 'contacted', 'converted', 'archived'))
    - source: text DEFAULT 'website'

    Include indexes:
    - created_at DESC (for dashboard sorting)
    - status (for filtering)

    Use Supabase CLI or SQL Editor in Supabase Dashboard to run this migration.

    Command: `supabase db push` if using CLI, or paste directly into SQL Editor.
  </action>
  <verify>Query leads table: SELECT * FROM leads; (should return empty result set with no errors)</verify>
  <done>Leads table exists in Supabase database with all specified columns and indexes</done>
</task>

<task type="auto">
  <name>Configure Row Level Security for leads table</name>
  <files>supabase/migrations/002_leads_rls_policies.sql</files>
  <action>
    Create RLS policies to secure the leads table.

    Enable RLS on leads table:
    ```sql
    ALTER TABLE leads ENABLE ROW LEVEL SECURITY;
    ```

    Create policies:

    1. Allow anonymous insert (for contact form):
    ```sql
    CREATE POLICY "Anyone can submit leads"
    ON leads FOR INSERT
    TO anon
    WITH CHECK (true);
    ```

    2. Allow authenticated users to read all leads (for admin):
    ```sql
    CREATE POLICY "Authenticated users can view all leads"
    ON leads FOR SELECT
    TO authenticated
    USING (true);
    ```

    3. Allow authenticated users to update leads (for status changes):
    ```sql
    CREATE POLICY "Authenticated users can update leads"
    ON leads FOR UPDATE
    TO authenticated
    USING (true)
    WITH CHECK (true);
    ```

    Run via Supabase CLI or SQL Editor.
  </action>
  <verify>
    Test RLS policies:
    1. Try inserting as anonymous (should succeed): INSERT INTO leads (name, email, message) VALUES ('Test', 'test@example.com', 'Test message');
    2. Try selecting as anonymous (should fail/return empty)
    3. Try selecting as authenticated user (should return rows)
  </verify>
  <done>RLS enabled on leads table with insert policy for anonymous users and full access policy for authenticated users</done>
</task>

</tasks>

<verification>
Overall verification checks:

1. Supabase project accessible at dashboard
2. Database contains leads table with correct schema
3. RLS policies in place and working as expected
4. Lovable project has Supabase credentials configured
5. Connection test successful (can query from Lovable environment)
</verification>

<success_criteria>
Plan complete when:

1. Supabase project exists and accessible via dashboard
2. Leads table created with all required columns
3. RLS policies configured for anonymous insert and authenticated read
4. Lovable project connected to Supabase with API credentials
5. Ready to receive form submissions from website

Measurable: Can manually insert a test row as anonymous and retrieve it as authenticated admin.
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-backend/02-01-SUMMARY.md` with:
- Supabase project URL
- Database schema overview
- RLS policies configured
- Connection status with Lovable
- Any credentials or configuration notes
</output>
