---
phase: 02-supabase-backend
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "src/pages/admin/Login.tsx"
  - "src/pages/admin/Dashboard.tsx"
  - "src/lib/auth.ts"
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to login page"
    - "Admin can sign in with email and password"
    - "Invalid credentials are rejected with error message"
    - "Successful login redirects to admin dashboard"
    - "Admin dashboard is protected (requires authentication)"
    - "Admin can sign out"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Authentication helper functions"
      exports: ["signIn", "signOut", "getCurrentUser"]
      min_lines: 20
    - path: "src/pages/admin/Login.tsx"
      provides: "Admin login page"
      contains: "supabase.auth.signInWithPassword"
    - path: "src/pages/admin/Dashboard.tsx"
      provides: "Protected admin dashboard"
      contains: "useEffect.*auth"
  key_links:
    - from: "Login.tsx"
      to: "src/lib/auth.ts"
      via: "import statement"
      pattern: "import.*auth.*from"
    - from: "Login.tsx"
      to: "Supabase Auth API"
      via: "signInWithPassword call"
      pattern: "signInWithPassword"
    - from: "Dashboard.tsx"
      to: "auth check"
      via: "useEffect with auth state"
      pattern: "useEffect.*getSession"
---

<objective>
Set up admin authentication using Supabase Auth so the owner can securely access the admin dashboard.

Purpose: Enable secure access control for the admin dashboard where leads and content will be managed.

Output: Working admin login flow with protected dashboard route and single admin user configured.
</objective>

<execution_context>
@C:\Users\vance\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\vance\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\PROJECT.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\ROADMAP.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\STATE.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\phases\02-supabase-backend\02-01-SUMMARY.md

Dependencies:
- Supabase project exists (from Plan 02-01)
- Supabase client configured (from Plan 02-01)

Key constraint from PROJECT.md:
- Single admin user (owner only)
- No multi-user role system needed
</context>

<tasks>

<task type="auto">
  <name>Create authentication helper utilities</name>
  <files>src/lib/auth.ts</files>
  <action>
    Create authentication utility functions for sign in, sign out, and session management.

    Create src/lib/auth.ts:
    ```typescript
    import { supabase } from './supabase'

    export async function signIn(email: string, password: string) {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        throw new Error(error.message)
      }

      return data
    }

    export async function signOut() {
      const { error } = await supabase.auth.signOut()

      if (error) {
        throw new Error(error.message)
      }
    }

    export async function getCurrentUser() {
      const { data: { user }, error } = await supabase.auth.getUser()

      if (error) {
        throw new Error(error.message)
      }

      return user
    }

    export async function getSession() {
      const { data: { session }, error } = await supabase.auth.getSession()

      if (error) {
        throw new Error(error.message)
      }

      return session
    }

    export function onAuthStateChange(callback: (event: string, session: any) => void) {
      return supabase.auth.onAuthStateChange(callback)
    }
    ```

    This provides a clean abstraction over Supabase Auth for use in components.
  </action>
  <verify>
    Check that auth.ts compiles without errors:
    ```bash
    cd C:\Users\vance\OneDrive\Desktop\claude-workspace\tgyardcare
    npm run build
    ```
    Should complete with no TypeScript errors related to auth utilities.
  </verify>
  <done>src/lib/auth.ts exists with sign in, sign out, and session management functions</done>
</task>

<task type="auto">
  <name>Create admin login page</name>
  <files>src/pages/admin/Login.tsx</files>
  <action>
    Create a simple admin login page with email/password form.

    Create src/pages/admin/Login.tsx:
    ```typescript
    import { useState } from 'react'
    import { useNavigate } from 'react-router-dom'
    import { signIn } from '@/lib/auth'

    export default function Login() {
      const [email, setEmail] = useState('')
      const [password, setPassword] = useState('')
      const [error, setError] = useState('')
      const [isLoading, setIsLoading] = useState(false)
      const navigate = useNavigate()

      const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setError('')
        setIsLoading(true)

        try {
          await signIn(email, password)
          navigate('/admin/dashboard')
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Login failed')
        } finally {
          setIsLoading(false)
        }
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
          <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 className="text-2xl font-bold mb-6 text-center">Admin Login</h1>

            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                {error}
              </div>
            )}

            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <label className="block text-gray-700 mb-2" htmlFor="email">
                  Email
                </label>
                <input
                  id="email"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div className="mb-6">
                <label className="block text-gray-700 mb-2" htmlFor="password">
                  Password
                </label>
                <input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <button
                type="submit"
                disabled={isLoading}
                className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:bg-gray-400"
              >
                {isLoading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>
          </div>
        </div>
      )
    }
    ```

    Ensure routing is configured for /admin/login (add to router config if needed).
  </action>
  <verify>
    Check that login page renders without errors:
    ```bash
    cd C:\Users\vance\OneDrive\Desktop\claude-workspace\tgyardcare
    npm run dev
    ```
    Navigate to http://localhost:5173/admin/login (or appropriate dev URL).
    Should see login form with no console errors.
  </verify>
  <done>Admin login page exists at /admin/login with email/password form, error handling, and loading states</done>
</task>

<task type="auto">
  <name>Create protected admin dashboard with auth guard</name>
  <files>src/pages/admin/Dashboard.tsx</files>
  <action>
    Create a basic protected admin dashboard that requires authentication.

    Create src/pages/admin/Dashboard.tsx:
    ```typescript
    import { useEffect, useState } from 'react'
    import { useNavigate } from 'react-router-dom'
    import { getCurrentUser, signOut } from '@/lib/auth'

    export default function Dashboard() {
      const [user, setUser] = useState<any>(null)
      const [isLoading, setIsLoading] = useState(true)
      const navigate = useNavigate()

      useEffect(() => {
        checkAuth()
      }, [])

      const checkAuth = async () => {
        try {
          const currentUser = await getCurrentUser()
          if (!currentUser) {
            navigate('/admin/login')
            return
          }
          setUser(currentUser)
        } catch (error) {
          console.error('Auth check failed:', error)
          navigate('/admin/login')
        } finally {
          setIsLoading(false)
        }
      }

      const handleSignOut = async () => {
        try {
          await signOut()
          navigate('/admin/login')
        } catch (error) {
          console.error('Sign out failed:', error)
        }
      }

      if (isLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <p>Loading...</p>
          </div>
        )
      }

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-2xl font-bold">Admin Dashboard</h1>
              <button
                onClick={handleSignOut}
                className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
              >
                Sign Out
              </button>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8">
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-semibold mb-4">Welcome, {user?.email}</h2>
              <p className="text-gray-600">
                Dashboard features will be added in Phase 5.
              </p>
            </div>
          </main>
        </div>
      )
    }
    ```

    Ensure routing is configured for /admin/dashboard.

    This dashboard is intentionally basic - Phase 5 will add lead viewing and content management.
  </action>
  <verify>
    1. Without being logged in, navigate to /admin/dashboard (should redirect to /admin/login)
    2. After successful login, should automatically navigate to dashboard
    3. Dashboard should display user email
    4. Sign Out button should log out and redirect to login
  </verify>
  <done>Protected admin dashboard exists at /admin/dashboard with auth guard, displays user info, and includes sign out functionality</done>
</task>

<task type="checkpoint:human-action">
  <name>Create admin user in Supabase</name>
  <action>
    You (the user) need to create the admin user account in Supabase.

    1. Go to Supabase Dashboard for tgyardcare project
    2. Navigate to Authentication -> Users
    3. Click "Add User" (or "Invite User")
    4. Enter:
       - Email: totalguardllc@gmail.com (or your preferred admin email)
       - Password: Create a strong password and save it securely
       - Auto Confirm User: Enable (so no email confirmation needed)
    5. Click "Create User"

    Note: Supabase Auth is enabled by default in all new projects. No additional configuration needed for basic email/password auth.

    Reply with: "Admin user created" when complete.
  </action>
  <verify>N/A - human setup</verify>
  <done>Admin user exists in Supabase with email and password</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Admin authentication system with login page, protected dashboard, and auth utilities. Single admin user configured in Supabase.
  </what-built>
  <how-to-verify>
    1. Open tgyardcare.com/admin/login in browser
    2. Try logging in with WRONG credentials (should see error message)
    3. Log in with correct admin credentials:
       - Email: (the one you created in Supabase)
       - Password: (the one you set)
    4. Verify successful login redirects to /admin/dashboard
    5. Verify dashboard shows:
       - "Welcome, [your-email]" message
       - Sign Out button in header
    6. Try accessing /admin/dashboard directly in new incognito window (should redirect to login)
    7. Click "Sign Out" button (should redirect to login and clear session)
    8. Try logging in again (should work)

    Expected behavior:
    - Login page shows validation errors for invalid credentials
    - Successful login redirects to dashboard
    - Dashboard is protected (requires auth)
    - Sign out works and clears session
    - Dashboard displays user email

    If everything works correctly, reply: "approved"

    If issues, describe what's not working (e.g., "login fails", "dashboard not protected", "sign out doesn't work").
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Overall verification checks:

1. Auth utility functions exist and work correctly
2. Login page renders and accepts credentials
3. Invalid credentials show error message
4. Valid credentials authenticate successfully
5. Successful login redirects to dashboard
6. Dashboard is protected (redirects to login if not authenticated)
7. Dashboard displays user information
8. Sign out functionality works and clears session
9. Admin user exists in Supabase Auth
10. No console errors during auth flow
</verification>

<success_criteria>
Plan complete when:

1. Admin can successfully log in at /admin/login
2. Invalid credentials are rejected with error message
3. Successful login redirects to /admin/dashboard
4. Dashboard is protected and requires authentication
5. Admin can sign out from dashboard
6. Auth state persists across page refreshes
7. Single admin user configured in Supabase

Measurable: Complete full auth flow (login -> dashboard -> sign out -> login again) without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-backend/02-03-SUMMARY.md` with:
- Authentication setup details
- Admin user credentials (email only, not password)
- Login page route
- Dashboard route
- Auth utilities created
- Test results from verification
</output>
