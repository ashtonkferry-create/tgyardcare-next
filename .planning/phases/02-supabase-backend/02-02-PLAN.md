---
phase: 02-supabase-backend
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "src/components/ContactForm.tsx"
  - "src/lib/supabase.ts"
autonomous: false

must_haves:
  truths:
    - "User can fill out contact form on website"
    - "Form submission saves to Supabase leads table"
    - "User sees confirmation message after submitting"
    - "Form submission triggers analytics event"
    - "Submitted data persists in database"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase client initialization"
      exports: ["supabase"]
      min_lines: 10
    - path: "src/components/ContactForm.tsx"
      provides: "Contact form component with Supabase integration"
      contains: "supabase.from('leads').insert"
  key_links:
    - from: "ContactForm.tsx"
      to: "src/lib/supabase.ts"
      via: "import statement"
      pattern: "import.*supabase.*from"
    - from: "ContactForm.tsx"
      to: "leads table"
      via: "Supabase insert"
      pattern: "supabase\\.from\\('leads'\\)\\.insert"
---

<objective>
Connect the website contact form to Supabase database so form submissions are stored persistently.

Purpose: Replace any placeholder form handling with real database persistence, enabling lead tracking and follow-up.

Output: Working contact form that saves submissions to Supabase leads table with user confirmation and analytics tracking.
</objective>

<execution_context>
@C:\Users\vance\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\vance\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\PROJECT.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\ROADMAP.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\STATE.md
@C:\Users\vance\OneDrive\Desktop\claude-workspace\.planning\phases\02-supabase-backend\02-01-SUMMARY.md

Dependencies:
- Supabase project connected (from Plan 02-01)
- Leads table exists with schema (from Plan 02-01)
- RLS policies configured (from Plan 02-01)
</context>

<tasks>

<task type="auto">
  <name>Create Supabase client utility</name>
  <files>src/lib/supabase.ts</files>
  <action>
    Create a Supabase client initialization file for use across the application.

    1. Install Supabase client library (if not already installed):
       ```bash
       npm install @supabase/supabase-js
       ```

    2. Create src/lib/supabase.ts:
       ```typescript
       import { createClient } from '@supabase/supabase-js'

       const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
       const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

       if (!supabaseUrl || !supabaseAnonKey) {
         throw new Error('Missing Supabase environment variables')
       }

       export const supabase = createClient(supabaseUrl, supabaseAnonKey)
       ```

    3. Verify environment variables are set in Lovable project settings:
       - VITE_SUPABASE_URL
       - VITE_SUPABASE_ANON_KEY

    Note: Lovable uses Vite, so env vars must be prefixed with VITE_. These should be configured via Lovable's interface (done in Plan 02-01).
  </action>
  <verify>
    Check that supabase.ts compiles without errors:
    ```bash
    cd C:\Users\vance\OneDrive\Desktop\claude-workspace\tgyardcare
    npm run build
    ```
    Should complete with no TypeScript errors related to Supabase client.
  </verify>
  <done>src/lib/supabase.ts exists, exports supabase client, and compiles without errors</done>
</task>

<task type="auto">
  <name>Wire contact form to Supabase with validation and feedback</name>
  <files>src/components/ContactForm.tsx</files>
  <action>
    Update the contact form component to save submissions to Supabase leads table.

    1. Find ContactForm component (likely in src/components/)
    2. Import Supabase client:
       ```typescript
       import { supabase } from '@/lib/supabase'
       ```

    3. Update form submission handler:
       ```typescript
       const handleSubmit = async (e: React.FormEvent) => {
         e.preventDefault()

         // Get form data
         const formData = new FormData(e.target as HTMLFormElement)

         // Prepare lead object
         const leadData = {
           name: formData.get('name') as string,
           email: formData.get('email') as string,
           phone: formData.get('phone') as string || null,
           service_interest: formData.get('service') as string || null,
           property_size: formData.get('propertySize') as string || null,
           message: formData.get('message') as string,
           source: 'website',
           status: 'new'
         }

         // Validate required fields
         if (!leadData.name || !leadData.email || !leadData.message) {
           alert('Please fill in all required fields')
           return
         }

         // Insert into Supabase
         const { data, error } = await supabase
           .from('leads')
           .insert([leadData])
           .select()

         if (error) {
           console.error('Error submitting form:', error)
           alert('Failed to submit form. Please try again.')
           return
         }

         // Success feedback
         alert('Thank you! We will contact you soon.')

         // Track analytics event (for Plan 02-04)
         if (window.gtag) {
           window.gtag('event', 'form_submit', {
             form_name: 'contact_form',
             lead_id: data[0]?.id
           })
         }

         // Reset form
         (e.target as HTMLFormElement).reset()
       }
       ```

    4. Ensure form fields have correct name attributes matching the leadData object
    5. Add loading state to prevent double-submission:
       ```typescript
       const [isSubmitting, setIsSubmitting] = useState(false)
       ```

    6. Update button to show loading state:
       ```typescript
       <button type="submit" disabled={isSubmitting}>
         {isSubmitting ? 'Submitting...' : 'Send Message'}
       </button>
       ```

    Note: Form field names may differ in existing implementation. Match them to the database schema from Plan 02-01.
  </action>
  <verify>
    1. Run development server:
       ```bash
       cd C:\Users\vance\OneDrive\Desktop\claude-workspace\tgyardcare
       npm run dev
       ```
    2. Open browser to contact form page
    3. Check browser console for any errors on page load
    4. Fill out form with test data and submit
    5. Verify no errors in console
    6. Check Supabase dashboard: Table Editor -> leads (should see new row)
  </verify>
  <done>Contact form submits data to Supabase leads table, shows user feedback, tracks analytics event, and resets after successful submission</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Contact form integration with Supabase database. Form submissions now save to leads table with validation, error handling, and user feedback.
  </what-built>
  <how-to-verify>
    1. Open tgyardcare.com in browser
    2. Navigate to contact form (likely on homepage or /contact page)
    3. Fill out the form with test data:
       - Name: Test Lead
       - Email: test@example.com
       - Phone: (optional)
       - Service: (select one)
       - Message: This is a test submission
    4. Click Submit button
    5. Verify you see success message: "Thank you! We will contact you soon."
    6. Open Supabase Dashboard -> Table Editor -> leads table
    7. Verify you see the test lead in the table with correct data
    8. Expected behavior:
       - Form shows loading state during submission
       - Success message appears after submit
       - Form clears after successful submission
       - Data appears in Supabase within seconds
    9. Test error handling: Try submitting with empty required fields (should show validation error)

    If everything works correctly, reply: "approved"

    If issues, describe what's not working (e.g., "form doesn't submit", "data not in database", "error message appears").
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Overall verification checks:

1. Supabase client utility exists and initializes correctly
2. Contact form imports and uses Supabase client
3. Form submission handler inserts data into leads table
4. Validation prevents incomplete submissions
5. User sees success feedback after submission
6. Form resets after successful submission
7. Analytics event tracked (gtag event fires)
8. Data persists in Supabase leads table
9. No console errors during form interaction
</verification>

<success_criteria>
Plan complete when:

1. Contact form successfully saves submissions to Supabase leads table
2. User receives confirmation message after submission
3. Form includes validation for required fields
4. Form resets after successful submission
5. Analytics event tracked for form submission
6. Manual test confirms data appears in Supabase dashboard

Measurable: Submit test form, see confirmation, verify row in Supabase leads table within 5 seconds.
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-backend/02-02-SUMMARY.md` with:
- Contact form integration details
- Supabase client setup
- Form fields mapped to database schema
- Validation rules implemented
- Analytics tracking configured
- Test submission results
</output>
